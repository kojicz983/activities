{% load leaflet_tags %}
<html>

<head>
    {% leaflet_js %}
    {% leaflet_css %}
    {% load static %}
    <script src="/static/geojson/serbia_municipality.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/static/js/markercluster/MarkerCluster.css" />
    <link rel="stylesheet" href="/static/js/markercluster/MarkerCluster.Default.css" />
    <script src="/static/js/markercluster/leaflet.markercluster-src.js"></script>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
        function renderSDGFilter() {
            var sdg_html = '<div class="dropdown">';
            sdg_html += '<button id="sdg_btn" onclick="sdgDropDown()" class="dropbtn">Select SDG</button>';
            sdg_html += '<div id="sdg" class="dropdown-content">';
            sdg_html += '<div id="sdg_0" onclick="filterSelected(sdg_0, \'sdg\')">Show all</div>';

            {% for sdg in sdgs %}
            sdg_html += '<div id="sdg_{{ sdg.id }}" value="{{ sdg.id }}" onclick="filterSelected(sdg_{{ sdg.id }}, \'sdg\')">{{ sdg.name }}</div>';
            {% endfor %}

            sdg_html += '</div>';
            sdg_html += '</div>';

            return sdg_html
        }

        function renderTopicFilter() {
            var topic_html = '<div class="dropdown">';
            topic_html += '<button id="topic_btn" onclick="topicDropDown()" class="dropbtn">Select Topic</button>';
            topic_html += '<div id="topic" class="dropdown-content">';
            topic_html += '<div id="topic_0" onclick="filterSelected(topic_0, \'topic\')">Show all</div>';

            {% for topic in topics %}
            topic_html += '<div id="topic_{{ topic.id }}" value="{{ topic.id }}" onclick="filterSelected(topic_{{ topic.id }}, \'topic\')">{{ topic.name }}</div>';
            {% endfor %}

            topic_html += '</div>';
            topic_html += '</div>';

            return topic_html
        }

        function renderCategoryFilter() {
            var category_html = '<div class="dropdown">';
            category_html += '<button id="category_btn" onclick="categoryDropDown()" class="dropbtn">Select Category</button>';
            category_html += '<div id="category" class="dropdown-content">';
            category_html += '<div id="category_0" onclick="filterSelected(category_0, \'category\')">Show all</div>';

            {% for category in categories %}
            category_html += '<div id="category_{{ category.id }}" value="{{ category.id }}" onclick="filterSelected(category_{{ category.id }}, \'category\')">{{ category.name }}</div>';
            {% endfor %}

            category_html += '</div>';
            category_html += '</div>';

            return category_html
        }

        function renderSliderFilter() {
            return '<div id="slider-range"></div>';
        }
    </script>
    <style>
        .leaflet-container { height: 100%; width: 100%}

            .dropdown-content {
                display: none;
                position: absolute;
                background-color: #f1f1f1;
                min-width: 160px;
                overflow: auto;
                box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
                z-index: 1;
            }

            .show {display: block;}
        </style>
</head>

<body>
    {% leaflet_map "main" %}
</body>
<script type="text/javascript">

    function getFillColor(municipality_name) {
        var match = false;
        for (var i in projects) {
            if (projects[i].location.name === municipality_name) {
                match = true;
                break;
            }
        }

        if (match === true) return 'rgb(0, 54, 128)'
        else
            return '#000'

    }

    function style(feature) {
        return {
            weight: 1,
            // opacity: 1,
            // color: 'rgb(255, 255, 255)',
            dashArray: '',
            // fillOpacity: 0.5,
            // fillColor: getFillColor(feature.properties.NAME_2)//'rgb(0, 54, 128)'
        };
    }

    var mapsPlaceholder = [];

    L.Map.addInitHook(function () {
        mapsPlaceholder.push(this);
    });

    var markers = null;
    function setMarkers(map, data) {
        markers = L.markerClusterGroup();

        for (var i = 0; i < data.length; i++) {
            var item = data[i];
            var marker = L.marker(new L.LatLng(item.location.latitude, item.location.longitude), { project: item }); //.on('click', markerClick);
            marker.bindPopup('<h1>' + item.project_name + '</h1>');
            markers.addLayer(marker);
        }

        map.addLayer(markers);
    }

    function deleteAllMarkers(map) {
        map.removeLayer(markers);
    }

    window.addEventListener("map:init", function (event) {

        var map = event.detail.map;

        // < !--Filters -->
        var filters = L.control({
            position: 'topleft'
        });

        filters.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'filters');
            div.innerHTML = renderSDGFilter() + renderTopicFilter() + renderCategoryFilter() + renderSliderFilter();
            return div;
        };

        filters.addTo(map);
        // < !--END Filters-- >

        // < !--Info -->
        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            // this.update();
            return this._div;
        };

        info.update = function (props, markers) {
            var html = '<h1>' + props.NAME_1 + ' okrug</h1>';
            html += '<h2>' + props.NAME_2 + '</h2>';
            for (var i = 0; i < markers.length; i++) {
                html += '<h4>' + markers[0].options.project.project_name + '</h4>';
                html += '<p>SDG: ' + markers[0].options.project.sdg.name + '</p>';
            }
            this._div.innerHTML = html;
        };

        info.addTo(map);
        // < !--END Info-- >

        function onEachFeature(feature, layer) {
            layer.on({
                click: highlightFeature
            });
        }

        function isMarkerInsidePolygon(marker, poly) {
            var polyPoints = poly.getLatLngs()[0];
            var x = marker.getLatLng().lat, y = marker.getLatLng().lng;

            var inside = false;
            for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
                var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
                var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

                var intersect = ((yi > y) != (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        };

        function highlightFeature(e) {
            var layer = e.target;
            var markers = [];
            map.eachLayer(function (item) {

                if (item instanceof L.Marker) {

                    if (item instanceof L.MarkerCluster) {
                        var clusterMarkers = item.getAllChildMarkers()
                        for (var i = 0; i < clusterMarkers.length; i++) {
                            if (isMarkerInsidePolygon(clusterMarkers[i], layer)) {
                                markers.push(clusterMarkers[i]);
                            }
                        }
                    } else if (isMarkerInsidePolygon(item, layer)) {
                        markers.push(item);
                    }
                }

            });

            // layer.setStyle({
            //     weight: 5,
            //     color: 'rgb(51, 136, 255)',
            //     dashArray: '',
            //     fillOpacity: 0.7,
            //     fillColor: 'rgb(51, 136, 255)'
            // });

            // if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            //     layer.bringToFront();
            // }

            info.update(layer.feature.properties, markers);
        }

        function markerClick(e) {
            var layer = e.target;
            debugger;
            info.update(layer.options.title);
        }

        var options = {
            clickable: true,
            style: style,
            onEachFeature: onEachFeature
        };

        L.geoJson(municipality_data, options).addTo(map);

        map.resetviewControl.setPosition('bottomleft');
        map.zoomControl.setPosition('bottomleft');

        var dataurl = '/api/activities/';

        fetch(dataurl)
            .then(function (resp) {
                return resp.json();
            })
            .then(function (data) {
                setMarkers(map, data)
            })
            .catch(function (error) {
                console.log(error);
            })
    });
</script>
<script>

    function sdgDropDown() {
        document.getElementById("sdg").classList.toggle("show");
    }

    function topicDropDown() {
        document.getElementById("topic").classList.toggle("show");
    }

    function categoryDropDown() {
        document.getElementById("category").classList.toggle("show");
    }

    function filterSelected(element, type) {

        if (type === 'sdg') {
            var sdg_value = element.getAttribute('value');
            document.getElementById("sdg_btn").textContent = element.textContent;
            document.getElementById("sdg_btn").value = sdg_value;
        }

        if (type === 'topic') {
            var topic_value = element.getAttribute('value');
            document.getElementById("topic_btn").textContent = element.textContent;
            document.getElementById("topic_btn").value = topic_value;
        }

        if (type === 'category') {
            var category_value = element.getAttribute('value');
            document.getElementById("category_btn").textContent = element.textContent;
            document.getElementById("category_btn").value = category_value;
        }

        var sdg = document.getElementById("sdg_btn").getAttribute('value');
        var topic = document.getElementById("topic_btn").getAttribute('value');
        var category = document.getElementById("category_btn").getAttribute('value');

        var url = '/api/activities/?';
        var params = {};
        if (sdg !== null && sdg !== 'null') { params.sdg = sdg };
        if (topic !== null && topic !== 'null') { params.topic = topic };
        if (category !== null && category !== 'null') { params.category = category };

        var query = Object.keys(params)
            .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
            .join('&');

        url = url + query;

        fetch(url, {
            method: 'get'
        }).then(function (response) {
            return response.json();
        }).then(function (data) {
            var map = mapsPlaceholder[0];
            deleteAllMarkers(map);
            setMarkers(map, data)
        }).catch(function (error) {
            console.log(error);
        });
    }

    // Close the dropdown if the user clicks outside of it
    window.onclick = function (event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }
</script>
<script>
    setTimeout(
        function () {
            $("#slider-range").slider({
                range: true,
                min: 0,
                max: 500,
                values: [75, 300],
                slide: function (event, ui) {
                    $("#amount").val("$" + ui.values[0] + " - $" + ui.values[1]);
                }
            });
            $("#amount").val("$" + $("#slider-range").slider("values", 0) +
                " - $" + $("#slider-range").slider("values", 1));
        }
    , 300);
</script>

</html>