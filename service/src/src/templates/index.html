{% load leaflet_tags %}
<html>
    <head>
        {% leaflet_js %}
        {% leaflet_css %}
        {% load static %}
        <script src="/static/geojson/serbia_municipality.js" type="text/javascript"></script>
		<link rel="stylesheet" href="/static/js/markercluster/MarkerCluster.css" />
		<link rel="stylesheet" href="/static/js/markercluster/MarkerCluster.Default.css" />
		<script src="/static/js/markercluster/leaflet.markercluster-src.js"></script>
        <style>
            .leaflet-container { height: 100%; width: 100%}
        </style>
    </head>
    <body>
            <div style="display:flex;">
                    <div>
                        <div>
                            <h3>Topic:</h3>
                            <form action="" name="topics">
                                    <input type="radio" value="0" name="topics" onclick="onOptionChange()">Show All<br>
                                {% for topic in topics %}
                                    <input type="radio" value={{ topic.id }} name="topics" onclick="onOptionChange()">{{ topic.name }}<br>
                                {% endfor %}
                            </form>
                        </div>
                        <div>
                            <h3>SDG:</h3>
                            <!-- <form>
                                {% for sdg in sdgs %}
                                    <input type="radio" value={{ sdg.id }} {% if request.POST.sdgs == sdg.id|slugify  %} selected {% endif %}>{{ sdg.name }}<br>
                                {% endfor %}
                            </form> -->
                            <div>
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-1.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-2.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-3.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-4.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-5.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-6.png" />
                            </div>
                            <div>
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-7.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-8.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-9.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-10.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-11.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-12.png" />
                            </div>
                            <div>
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-13.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-14.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-15.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-16.png" />
                                <img style="height: 48px; width: 48px;" src="/static/images/sdg-17.png" />
                            </div>
                        </div>
                        <div>
                            <h3>Category:</h3>
                            <!-- <form action="">
                                {% for category in categories %}
                                    <input type="radio" value={{ category.id }}>{{ category.name }}<br>
                                {% endfor %}
                            </form> -->
                        </div>
                    </div>
                    {% leaflet_map "main" %}
                </div>
    </body>
    <script type="text/javascript">

        var projects = null;
        var markers = null;
        var info = null;
        var map = null;

        function onOptionChange() {

            var topic = 0;
            var topics = document.getElementsByName("topics");

            for (var i in topics) {
                if (topics[i].checked) {
                    topic = topics[i].value;
                }
            }

            var url = '/api/activities/?';
            var params = {};
            if (topic != 0) { params.topic = topic };

            var query = Object.keys(params)
                .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                .join('&');

            url = url + query;

            fetch(url, {
                method: 'get'
            }).then(function (response) {
                return response.json();
            }).then(function (data) {
                projects = data;
                var map = mapsPlaceholder[0];
                deleteAllMarkers(map);
                setMarkers(map, data)
            }).catch(function (error) {
                console.log(error);
            });
        }

        function getFillColor(municipality_name) {
            var match = false;
            for (var i in projects) {
                if(projects[i].location.name === municipality_name) {
                    match = true;
                    break;
                }
            }

            if (match === true) return 'rgb(0, 54, 128)'
            else
            return '#000'

        }

        function style(feature) {
            return {
                weight: 1,
                 opacity: 1,
                 color: 'rgb(255, 255, 255)',
                dashArray: '',
                fillOpacity: 0.5,
                fillColor: getFillColor(feature.properties.NAME_2)//'rgb(0, 54, 128)'
            };
        }

        var mapsPlaceholder = [];

        L.Map.addInitHook(function () {
          mapsPlaceholder.push(this);
        });

        function setMarkers(map, data) {
            markers = L.markerClusterGroup();

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var marker = L.marker(new L.LatLng(item.location.latitude, item.location.longitude), { project: item }); //.on('click', markerClick);
                marker.bindPopup('<h1>' + item.project_name + '</h1>');
                markers.addLayer(marker);
            }

            map.addLayer(markers);
        }

        function updateMunicipalityInfo(props, markers) {
            var element = document.getElementById('mun_info');

            var html = '';
            html += '<h2>' + props.NAME_2 + '</h2>';
            for(var i = 0; i < markers.length; i++) {
                html += '<div style="border: solid; border-width: 1px;">'
                html += '<p>PROJECT NAME: ' + markers[0].options.project.project_name + '</p>';
                html += '<p>SDG: ' + markers[0].options.project.sdg.name + '</p>';
                html += '<p>VALUE: ' + markers[0].options.project.activity_value + ' USD</p>';
                html += '</div>'
            }
            element.innerHTML = html;
        };

        function highlightFeature(e) {
            var layer = e.target;
            var markers = [];
            map.eachLayer(function(item) {

                if (item instanceof L.Marker) {

                    if (item instanceof L.MarkerCluster) {
                        var clusterMarkers = item.getAllChildMarkers()
                        for(var i = 0; i < clusterMarkers.length; i++) {
                            if (isMarkerInsidePolygon(clusterMarkers[i], layer)) {
                                markers.push(clusterMarkers[i]);
                            }
                        }
                    } else if (isMarkerInsidePolygon(item, layer)) {
                        markers.push(item);
                    }
                }

            });

            updateMunicipalityInfo(layer.feature.properties, markers)
            //info.update(layer.feature.properties, markers);
        }

        function markerClick(e) {
            var layer = e.target;
            debugger;
            info.update(layer.options.title);
        }

        function onEachFeature(feature, layer) {
            layer.on({
                click: highlightFeature
            });
        }

        function isMarkerInsidePolygon(marker, poly) {
            var polyPoints = poly.getLatLngs()[0];
            var x = marker.getLatLng().lat, y = marker.getLatLng().lng;

            var inside = false;
            for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
                var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
                var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

                var intersect = ((yi > y) != (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        };

        window.addEventListener("map:init", function(event) {

            map = event.detail.map;

            var options = {
                clickable: true,
                style: style,
                onEachFeature: onEachFeature
            };

            L.geoJson(municipality_data, options).addTo(map);

            map.resetviewControl.setPosition('topright');
            map.zoomControl.setPosition('topright');

            var dataurl = '/api/activities/';

            fetch(dataurl)
                .then(function(resp) {
                    return resp.json();
                })
               .then(function(data) {
                   setMarkers(map, data)
                })
                .catch(function(error) {
                    console.log(error);
                })
        });
    </script>
</html>