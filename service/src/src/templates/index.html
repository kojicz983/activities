{% load leaflet_tags %}
<html>
    <head>
        {% leaflet_js %}
        {% leaflet_css %}
        {% load static %}
        <script src="/static/geojson/serbia_municipality.js" type="text/javascript"></script>
		<link rel="stylesheet" href="/static/js/markercluster/MarkerCluster.css" />
		<link rel="stylesheet" href="/static/js/markercluster/MarkerCluster.Default.css" />
		<script src="/static/js/markercluster/leaflet.markercluster-src.js"></script>
        <style>
            .leaflet-container { height: 100%; width: 100%}
        </style>
    </head>
    <body>
        <div>
            <form method="POST">
                {% csrf_token %}
                <select name="sdgs" data-placeholder="Prikazi sve" onchange="this.form.submit()">
                    <option value="0">Prikazi sve</option>
                    {% for sdg in sdgs %}
                    <option value={{ sdg.id }} {% if request.POST.sdgs == sdg.id|slugify  %} selected {% endif %}>{{ sdg.name }}</option>
                    {% endfor %}
                </select>
                <select name="topics" data-placeholder="Prikazi sve">
                        <option value="0">Prikazi sve</option>
                        {% for topic in topics %}
                        <option value={{ topic.id }} {% if request.POST.topics == topic.id|slugify  %} selected {% endif %}>{{ topic.name }}</option>
                        {% endfor %}
                </select>
                <select name="categories" data-placeholder="Prikazi sve">
                        <option value="0">Prikazi sve</option>
                        {% for category in categories %}
                        <option value={{ category.id }} {% if request.POST.categories == category.id|slugify  %} selected {% endif %}>{{ category.name }}</option>
                        {% endfor %}
                </select>
            </form>
        </div>
            {% leaflet_map "main" %}
    </body>
    <script type="text/javascript">

        function getFillColor(municipality_name) {
            var match = false;
            for (var i in projects) {
                //console.log('Location', projects[i].location);
                //console.log('Municipality', municipality_name);
                if(projects[i].location.name === municipality_name) {
                    match = true;
                    break;
                }
            }

            if (match === true) return 'rgb(0, 54, 128)'
            else
            return '#000'

        }

        function style(feature) {
            return {
                weight: 1,
                // opacity: 1,
                // color: 'rgb(255, 255, 255)',
                dashArray: '',
                // fillOpacity: 0.5,
                // fillColor: getFillColor(feature.properties.NAME_2)//'rgb(0, 54, 128)'
            };
        }

        window.addEventListener("map:init", function(event) {

            var map = event.detail.map;

            var info = L.control();

            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info');
                // this.update();
                return this._div;
            };

            info.update = function (props, markers) {
                var html = '<h1>' + props.NAME_1 + ' okrug</h1>';
                html += '<h2>' + props.NAME_2 + ' okrug</h2>';
                for(var i = 0; i < markers.length; i++) {
                    html += '<h4>' + markers[0].options.project.project_name + '</h4>';
                    html += '<p>SDG: ' + markers[0].options.project.sdg.name + '</p>';
                }
                this._div.innerHTML = html;
            };

            info.addTo(map);

            function onEachFeature(feature, layer) {
                layer.on({
                    click: highlightFeature
                });
            }

            function isMarkerInsidePolygon(marker, poly) {
                var polyPoints = poly.getLatLngs()[0];
                var x = marker.getLatLng().lat, y = marker.getLatLng().lng;

                var inside = false;
                for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
                    var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
                    var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

                    var intersect = ((yi > y) != (yj > y))
                        && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }

                return inside;
            };

            function highlightFeature(e) {
                var layer = e.target;
                var markers = [];
                map.eachLayer(function(item) {

                    if (item instanceof L.Marker) {

                        if (item instanceof L.MarkerCluster) {
                            var clusterMarkers = item.getAllChildMarkers()
                            for(var i = 0; i < clusterMarkers.length; i++) {
                                if (isMarkerInsidePolygon(clusterMarkers[i], layer)) {
                                    markers.push(clusterMarkers[i]);
                                    console.log(clusterMarkers[i]._leaflet_id);
                                }
                            }
                        } else if (isMarkerInsidePolygon(item, layer)) {
                            markers.push(item);
                            console.log(item._leaflet_id);
                        }
                    }

                })

                // layer.setStyle({
                //     weight: 5,
                //     color: 'rgb(51, 136, 255)',
                //     dashArray: '',
                //     fillOpacity: 0.7,
                //     fillColor: 'rgb(51, 136, 255)'
                // });

                // if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                //     layer.bringToFront();
                // }

                info.update(layer.feature.properties, markers);
            }

            function markerClick(e) {
                var layer = e.target;
                debugger;
                info.update(layer.options.title);
            }

            var options = {
                clickable: true,
                style: style,
                onEachFeature: onEachFeature
            };

            L.geoJson(municipality_data, options).addTo(map);

            map.resetviewControl.setPosition('bottomleft');
            map.zoomControl.setPosition('bottomleft');

            var dataurl = '/api/activities/';

            fetch(dataurl)
                .then(function(resp) {
                    return resp.json();
                })
               .then(function(data) {

                    var markers = L.markerClusterGroup();

                    for (var i = 0; i < data.length; i++) {
                        // debugger;
                        var item = data[i];
                        var marker = L.marker(new L.LatLng(item.location.latitude, item.location.longitude), { project: item }); //.on('click', markerClick);
                        marker.bindPopup('<h1>' + item.prject_name + '</h1>');
                        markers.addLayer(marker);
                        // var marker = L.marker(new L.LatLng(a.location.latitude, a.location.longitude)).on('click', highlightFeature).addTo(map);
                    }

                    map.addLayer(markers);


                })
                .catch(function(error) {
                    console.log(error);
                })
        });
    </script>
</html>